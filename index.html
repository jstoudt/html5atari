<!doctype html>

<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>6507 Emulation Testing</title>
	<link rel="stylesheet" href="css/style.css">
</head>
<body>
	<div id="main">
		<div class="register-wrapper">
			<label>Accumulator</label>
			<div id="ac" class="register"></div>

			<label>X</label>
			<div id="x" class="register"></div>

			<label>Y</label>
			<div id="y" class="register"></div>

			<label>Stack</label>
			<div id="sp" class="register"></div>

			<label>PC</label>
			<div id="pc" class="register"></div>
		</div>

		<table id="status">
			<thead>
				<tr>
					<th>N</th>
					<th>V</th>
					<th></th>
					<th>B</th>
					<th>D</th>
					<th>I</th>
					<th>Z</th>
					<th>C</th>
				</tr>
			</thead>
			<tbody>
				<tr>
					<td id="N"></td>
					<td id="V"></td>
					<td>X</td>
					<td id="B"></td>
					<td id="D"></td>
					<td id="I"></td>
					<td id="Z"></td>
					<td id="C"></td>
				</tr>
			</tbody>
		</table>

		<div class="frequency-wrapper">
			<label>TIA Clock Frequency</label>
			<div id="tia-frequency" class="register"></div><span>MHz</span>
			<br><br>
			<label>Frame Rate</label>
			<div id="frame-rate" class="register"></div><span>frames/sec</span>
		</div>

		<div class="tv-wrapper">
			<canvas id="television" width="160" height="192"></canvas>
		</div>
		
		<div class="controls">
			<button id="start" disabled>Start</button>
			<button id="stop" disabled>Stop</button>
			<button id="reset" disabled>Reset</button>
			<button id="step" disabled>Step</button>
		</div>
		<table id="memory">
			<thead>
				<th>00xx</th>
				<th>0</th>
				<th>1</th>
				<th>2</th>
				<th>3</th>
				<th>4</th>
				<th>5</th>
				<th>6</th>
				<th>7</th>
				<th>8</th>
				<th>9</th>
				<th>a</th>
				<th>b</th>
				<th>c</th>
				<th>d</th>
				<th>e</th>
				<th>f</th>
			</thead>
			<tbody>
				<tr>
					<td class="leftcol">80</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">90</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">a0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">b0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">c0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">d0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">e0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
				<tr>
					<td class="leftcol">f0</td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
					<td></td>
				</tr>
			</tbody>
		</table>
	</div>
	<script src="js/memory.js"></script>
	<script src="js/tia.js"></script>
	<script src="js/riot.js"></script>
	<script src="js/6507.js"></script>
	<script>

	(function() {

		var ac           = document.getElementById('ac'),
			x            = document.getElementById('x'),
			y            = document.getElementById('y'),
			sp           = document.getElementById('sp'),
			pc           = document.getElementById('pc'),
			instructions = document.getElementById('instructions'),
			memTable     = document.getElementById('memory'),
			cells        = memTable.getElementsByTagName('td'),
			television   = document.getElementById('television'),
			memCells     = [],
			i            = 0,

			sr = {
				N: document.getElementById('N'),
				V: document.getElementById('V'),
				B: document.getElementById('B'),
				D: document.getElementById('D'),
				I: document.getElementById('I'),
				Z: document.getElementById('Z'),
				C: document.getElementById('C')
			};

		for (; i < cells.length; i++) {
			if (cells[i].className !== 'leftcol') {
				memCells.push(cells[i]);
			}
		}

		document.addEventListener('DOMContentLoaded', function() {

			TIA.init(television);

			var xhr = new XMLHttpRequest();
			xhr.open('GET', 'rom/bin/Combat.bin', true);
			xhr.responseType = 'arraybuffer';

			xhr.onerror = function() {
				alert('Failed to load resource.');
			};

			xhr.onload = function() {

				var prog         = new Uint8Array(xhr.response),
					startBtn     = document.getElementById('start'),
					stopBtn      = document.getElementById('stop'),
					resetBtn     = document.getElementById('reset'),
					stepBtn      = document.getElementById('step'),
					tiaTime0     = Date.now(),
					tiaCycles0   = TIA.getCycleCount(),
					tiaFrames0   = TIA.getNumFrames(),
					tiaFrequency = document.getElementById('tia-frequency'),
					frameRate    = document.getElementById('frame-rate'),
					breakFlag    = true,

					showInfo = function() {
						var i      = 0,
							status = CPU6507.getRegister('sr'),
							mem    = TIA.getMemoryCopy(0x80, 128),
							len    = mem.length,
							toHex  = function(hex, digits) {
								hex = hex.toString(16);
								while (hex.length < digits) {
									hex = '0' + hex;
								}
								return hex;
							},
							reqAnimFrame = window.requestAnimationFrame ||
								window.mozRequestAnimationFrame ||
								window.webkitRequestAnimationFrame;

						ac.innerHTML = toHex(CPU6507.getRegister('ac'), 2);
						x.innerHTML  = toHex(CPU6507.getRegister('x'), 2);
						y.innerHTML  = toHex(CPU6507.getRegister('y'), 2);
						sp.innerHTML = toHex(CPU6507.getRegister('sp'), 2);
						pc.innerHTML = toHex(CPU6507.getRegister('pc'), 2);

						sr.N.innerHTML = status & 0x80 ? 1 : 0;
						sr.V.innerHTML = status & 0x40 ? 1 : 0;
						sr.B.innerHTML = status & 0x10 ? 1 : 0;
						sr.D.innerHTML = status & 0x08 ? 1 : 0;
						sr.I.innerHTML = status & 0x04 ? 1 : 0;
						sr.Z.innerHTML = status & 0x02 ? 1 : 0;
						sr.C.innerHTML = status & 0x01 ? 1 : 0;

						for (; i < len; i++) {
							memCells[i].innerHTML = toHex(mem[i], 2);
						}

						if (breakFlag !== true) {
							reqAnimFrame(showInfo);
						}
					},

					calcCycleRate = function() {
						var tiaTime1   = Date.now(),
							tiaCycles1 = TIA.getCycleCount(),
							tiaFrames1 = TIA.getNumFrames();

						tiaFrequency.innerHTML = Math.round((tiaCycles1 - tiaCycles0) / (tiaTime1 - tiaTime0)) / 1e3;

						frameRate.innerHTML = Math.round((tiaFrames1 - tiaFrames0) / (tiaTime1 - tiaTime0) * 1e6) / 1000;

						tiaCycles0 = tiaCycles1;
						tiaTime0   = tiaTime1;
						tiaFrames0 = tiaFrames1;

						if (breakFlag !== true) {
							setTimeout(calcCycleRate, 1000);
						}
					};

				CPU6507.loadProgram(prog, 0xf000);

				startBtn.removeAttribute('disabled');
				startBtn.addEventListener('click', function() {
					startBtn.setAttribute('disabled', 'disabled');
					stopBtn.removeAttribute('disabled');
					resetBtn.setAttribute('disabled', 'disabled');
					stepBtn.setAttribute('disabled', 'disabled');

					// start the magic
					TIA.start();

					// monitor the magic as it happens
					breakFlag = false;
					showInfo();
					calcCycleRate();

				}, false);

				stopBtn.addEventListener('click', function() {
					TIA.stop();
					stopBtn.setAttribute('disabled', 'disabled');
					startBtn.removeAttribute('disabled');
					resetBtn.removeAttribute('disabled');
					stepBtn.removeAttribute('disabled');
					breakFlag = true;
				}, false);

				resetBtn.removeAttribute('disabled');
				resetBtn.addEventListener('click', function() {
					TIA.init(television);
					CPU6507.loadProgram(prog, 0xf000);
				}, false);

				stepBtn.removeAttribute('disabled');
				stepBtn.addEventListener('click', function() {
					breakFlag = true;
					TIA.step();
					showInfo();
				}, false);
/*
				CPU6507.addEventListener('execloop', function(inst) {
					var pos = TIA.getBeamPosition();
					console.log('y: ' + pos.y + ' x: ' + pos.x +
						'\t' + inst.abbr +
						'\t' + inst.operand +
						'\t0x' + inst.opcode.toString(16) +
						'\t' + inst.addressing + 
						'\t' + inst.cycles +
						'\tA: ' + CPU6507.getRegister('ac') +
						'\tX: ' + CPU6507.getRegister('x') +
						'\tY: ' + CPU6507.getRegister('y') +
						'\tPC: ' + CPU6507.getRegister('pc').toString(16));
				});
*/
			};

			xhr.send();

		}, false);

	})();

	</script>
<!--
	<script>
		window.onload = function() {
			var iframe = document.createElement('iframe');
			iframe.width = '1';
			iframe.height = '1';
			iframe.src = 'about:blank';
			document.body.appendChild(iframe);
			
			setTimeout(function() {
				var innerWindow = iframe.contentWindow;

				for (var attr in self) {
					if (attr in innerWindow) {
						continue;
					}
					console.log('Added ' + attr);
				}

			}, 3000);
		};
	</script>
-->
</body>
</html>